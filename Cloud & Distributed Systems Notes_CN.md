
# 分散式系統一課筆記（Tim Berglund）

## 什麼是分散式系統？
一個**由多台獨立電腦組成**，在使用者眼中**像是一台電腦**的系統。  

**核心特徵：**
- **並行性**：多台機器同時運作。  
- **獨立失敗**：任何節點可能獨立故障。  
- **沒有全域時鐘**：時序不同步，導致排序困難。  

---

## 三大主題
- **儲存 (Storage)**  
- **計算 (Computation)**  
- **訊息傳遞 (Messaging)**  

---

## 1) 儲存

### 1.1 單一主節點
- 一台資料庫處理所有讀寫。  
- **強一致性**（寫後讀立即可見）。  
- 擴展有限，容易成為瓶頸。  

### 1.2 讀取複製
- **主從架構**：寫入到主節點，複製到從節點。  
- 優點：可擴展讀取量。  
- 缺點：會產生**最終一致性**問題。  

### 1.3 分片
- 根據 **分片鍵**（例如 username 範圍）切分資料。  
- 優點：可擴展寫入與總資料量。  
- 缺點：跨分片 **JOIN 困難**，常需**反正規化**。  

### 1.4 一致性雜湊
- 將 key 經雜湊 → 放到 **環上節點**。  
- 節點增減時，只有**少量 key**需搬移。  

### 1.5 Quorum 與可調一致性
- 複製因子 `N`：  
  - **寫入需要 W 節點成功**。  
  - **讀取需要 R 節點成功**。  
  - 規則：`R + W > N` ⇒ 強一致性。  

### 1.6 CAP 定理
- **一致性 (C)、可用性 (A)、分區容忍 (P)**，在分區時只能滿足其中兩個。  
- **CP 系統**：犧牲可用性保持一致。  
- **AP 系統**：犧牲一致性保持可用。  

---

## 2) 計算

### 2.1 MapReduce
- 流程：**Map → Shuffle → Reduce**。  
- 例子：文字計數。  
- 優點：適合大批次工作。  
- 缺點：高延遲、難寫程式。  

### 2.2 Hadoop vs Spark
- **Hadoop**：批次導向，依賴 HDFS。  
- **Spark**：高階 API（RDD/Dataset）、支援多種儲存後端、效能與開發體驗更好。  

### 2.3 串流處理
- 在資料**傳輸中即時計算**，而非等資料存下來再處理。  
- Kafka Streams / Flink → **低延遲、即時分析**。  

### 2.4 Lambda 架構（反例）
- 批次 + 即時雙路徑。  
- 問題：**重複邏輯**，維護成本高。  
- 趨勢：使用現代串流框架統一處理。  

---

## 3) 訊息傳遞

### 3.1 為什麼需要訊息機制
- 讓微服務 **鬆耦合**，避免共用資料庫。  

### 3.2 Kafka — 核心概念
- **Message（訊息）**：事件或紀錄。  
- **Topic（主題）**：訊息的命名日誌。  
- **Producer（生產者）**：寫入訊息。  
- **Consumer（消費者）**：讀取訊息。  
- **Broker（代理節點）**：Kafka 伺服器。  

### 3.3 分區與順序
- Topic 切成 **多個分區**。  
- **分區內有序**，全域無序。  
- 使用 **Key 分區** 保證相關訊息順序。  

### 3.4 複製與容錯
- 分區在多個 broker 上有複本。  
- 節點故障時 → **選舉新 leader**。  

### 3.5 消費者群組
- 消費者分工讀取分區 → **並行處理**。  
- Offset 記錄進度 → 支援 **重播**。  

### 3.6 傳遞語義
- **至少一次**：可能有重複。  
- **僅一次**：透過冪等生產者與交易保證。  

### 3.7 保留與事件日誌
- Topic 可設定 **保留策略**（時間/大小/壓縮）。  
- 支援事件 **重播**，重建狀態或支援新服務。  

---

## 核心收穫
- 分散式系統能擴展，但必然有**取捨**。  
- 必須理解 **一致性、延遲、失敗模式**。  
- 善用專門工具：**Cassandra（儲存）、Spark（計算）、Kafka（訊息）**。  